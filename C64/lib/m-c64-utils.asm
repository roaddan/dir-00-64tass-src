;--------------------------------------; fichier......: m-utils.asm (seq); type fichier.: macros; auteur.......: daniel lafrance; version......: 0.0.1; revision.....: 20151126;--------------------------------------; Affichage d'un caractere par kernal.;--------------------------------------outcar  .macro carno        php        pha        lda #\carno        jsr chrout        pla        plp        .endm        ;--------------------------------------; Affiche une chaine de caracteres par; le kernal.;--------------------------------------outstr  .macro string        jsr pushregs        ldy #>\string+1        ldx #<\string        jsr putsyx        jsr popregs        .endm;--------------------------------------; Affiche une chaine de caracteres par; le kernal a la position (x,y).;--------------------------------------outstrxy  .macro string        jsr pushregs        ldx \string        ldy \string+1        jsr gotoxy        ldy #>\string+2        ldx #<\string+2        jsr putsyx        jsr popregs        .endm;--------------------------------------; Charge le contenu 16 bits d'un; pointeur dans $YYXX.;--------------------------------------ldyxptr .macro pointeur        php        ldy \pointeur+1        ldx \pointeur        plp        .endm;--------------------------------------; Sauvegarde en mempore le contenu 16 ; bits $YYXX la la position pointeur.;--------------------------------------styxptr .macro pointeur        php        sty \pointeur+1        stx \pointeur        plp        .endm;--------------------------------------; Charge une adresse en immediat dans; $YYXX.;--------------------------------------ldyximm .macro immval        php        ldy #>\immval        ldx #<\immval        plp        .endm;--------------------------------------; Macros pour peupler AAXX.;--------------------------------------loadaxmem .macro axadd        php        ldx  \axadd   ;lsb adr dans X.        lda  \axadd+1 ;msb adr dans A.        plp        .endm;--------------------------------------; Charge un un nombre 16 bits dans ; $AAXX.;--------------------------------------loadaximm .macro aximm         php         ldx  #<\aximm ;LSB val dans x.         lda  #>\aximm ;MSB val dans a.         plp         .endm;--------------------------------------; Charge un pointeur $YYXX dans zpage1.;--------------------------------------ptrtozp1 .macro immval        jsr pushregs        ldy #>\immval        ldx #<\immval        sty zp1+1        stx zp1        jsr popregs        .endm;--------------------------------------; Charge un pointeur $YYXX dans zpage2.;--------------------------------------ptrtozp2 .macro immval        jsr pushregs        ldy #>\immval        ldx #<\immval        sty zp2+1        stx zp2        jsr popregs        .endm;--------------------------------------; Place sur la pile tous les registres.;--------------------------------------mpushr  .macro        php        pha        txa        pha        tya        pha        .endm;--------------------------------------; Recupere les registres de la pile.;--------------------------------------mpopr   .macro        pla        tay        pla        tax        pla        plp        .endm        ;--------------------------------------; Initialise les donneed de la fonction; loop.;--------------------------------------setloop .macro lcount        pha        lda  #<\lcount        sta  loopcount        lda  #>\lcount        sta  loopcount+1        pla        .endm;--------------------------------------; Permet les changement de police avec ; [C=]+[SHIFT].;--------------------------------------enable         .macro               php               pha               lda  #$09               jsr  $ffd2               pla               plp               .endm;--------------------------------------; Inhibe les changement de police avec ; [C=]+[SHIFT].;--------------------------------------disable        .macro               php               pha               lda  #$08               jsr  $ffd2               pla               plp               .endm;--------------------------------------; Charge une adresse 16 bits dans $YYXX;--------------------------------------loadxymem      .macro xyadd               php               ldx  \xyadd               ldy  \xyadd+1               plp               .endm;--------------------------------------; Charge le contenu 16 bits d'une case ; memoire dans $YYXX.;--------------------------------------loadxyimm      .macro xyimm               php               ldx  #>\xyimm               ldy  #<\xyimm               plp               .endm;--------------------------------------; Selectionne le jeu de caracteres; minuscule.;--------------------------------------tolower        .macro               php               pha               lda  #14               jsr  $ffd2               pla               plp               .endm;--------------------------------------; Selectionne le jeu de caracteres; majuscule.;--------------------------------------toupper        .macro               php               pha               lda  #b_uppercase               jsr  $ffd2               pla               plp               .endm;--------------------------------------; Change la couleur de la bordure.;--------------------------------------changebord     .macro c               pha               lda  #\c               sta  $d020               pla               .endm;--------------------------------------; Change la couleur de l'arriere plan; de l'ecran.;--------------------------------------changeback     .macro c               pha               lda  #\c               sta  $d021               pla               .endm;--------------------------------------; Sélectionne les couleurs naturelle du; commodore 64.;--------------------------------------c64color       .macro               jsr  pushregs               #changebord cbleupale               #changeback cbleu               #color cbleupale               jsr  popregs               .endm;--------------------------------------; Sélectionne mes couleurs préférées.;--------------------------------------mycolor        .macro               jsr  pushregs               #changebord cvert               #changeback cbleu               #color cblanc               jsr  popregs               .endm;--------------------------------------; Couleurs Commodore 64 + texte blanc;--------------------------------------c64col         .macro               jsr  pushregs               #changebord cbleupale               #changeback cbleu               #color cblanc               jsr  popregs               .endm;--------------------------------------; Sélectionne les couleurs naturelle du; commodore Vic 20.;--------------------------------------v20col         .macro               jsr  pushregs               #changebord ccyan               #changeback cblanc               #color cbleu               jsr  popregs               .endm;--------------------------------------; Sélectionne un jeu de couleurs grises;--------------------------------------graycolor      .macro               jsr  pushregs               #changebord cgrismoyen               #changeback cgrisfonce               #color cgrispale               jsr  popregs               .endm;--------------------------------------; Place une adresse dans ZP1.;--------------------------------------setzpage1      .macro addr               pha               lda  \addr               sta  $fb               lda  \addr+1               sta  $fc               pla               .endm;--------------------------------------; Place une adresse dans ZP1.;--------------------------------------setzpage2      .macro addr               pha               lda  \addr               sta  $fd               lda  \addr+1               sta  $fe               pla               .endm;--------------------------------------; Deplace le curseur a la position ; (x,y).;--------------------------------------locate      .macro x,y            jsr pushregs            ldx #\x            ldy #\y            jsr gotoxy            jsr popregs            .endm;--------------------------------------; Sélectionne la couleur du texte.;--------------------------------------color          .macro    col               pha               lda  #\col               sta  bascol               pla               .endm;--------------------------------------; Affiche une chaine pointée par $YYXX.;--------------------------------------print          .macro strptr               jsr  pushregs               ldx  #<\strptr               ldy  #>\strptr               jsr  putsyx               jsr  popregs               .endm;--------------------------------------; Affiche une chaine pointée par $YYXX; suivie par une crlf.;--------------------------------------println        .macro strptr               jsr  pushregs               ldx  #<\strptr               ldy  #>\strptr               jsr  putsyx               lda  #$0d               jsr  chrout               jsr  popregs               .endm;--------------------------------------; Affiche une chaine pointée par $YYXX; à la position X,Y.;--------------------------------------print_xy        .macro x,y,strptr                jsr  pushregs                ldy  #\x                ldx  #\y                clc                jsr  plot                ldx  #<\strptr                 ldy  #>\strptr                jsr  putsyx                jsr  popregs                .endm;--------------------------------------; Affiche une chaine pointée par $YYXX; à la position X,Y dans ka couleur C.;--------------------------------------print_cxy       .macro c,x,y,strptr                jsr pushregs                lda bascol                pha                 lda #\c                sta bascol                ldy #\x                ldx  #\y                clc                jsr  plot                ldx  #<\strptr                 ldy  #>\strptr                jsr  putsyx                pla                sta  bascol                jsr  popregs                .endm;--------------------------------------; Affiche une chaine pointée par $YYXX; à la position X,Y.;--------------------------------------printxy        .macro strptr               jsr  pushregs               ldx  #<\strptr                ldy  #>\strptr               jsr  putsxy               jsr  popregs               .endm;--------------------------------------; Affiche une chaine pointée par $YYXX; à la position X,Y dans ka couleur C.;--------------------------------------printcxy       .macro strptr               jsr  pushregs               ldx  #<\strptr                ldy  #>\strptr               jsr  putscxy               jsr  popregs               .endm;--------------------------------------; Affiche un texte précédé d'un préfixe;--------------------------------------printfmt       .macro prefix, strptr               jsr  pushregs               lda  #\prefix               jsr  chrout               #print \strptr               jsr  popregs               .endm;--------------------------------------; Affiche une chaine pointée par $YYXX; à la position X,Y.;--------------------------------------printpos       .macro x,y,strptr               jsr  pushregs               #locate \x,\y               #print \strptr               jsr  popregs               .endm;--------------------------------------; Affiche un texte précédé d'un préfixe; à la position X,Y.;--------------------------------------printfmtxy     .macro x,y,prefix,strptr               jsr  pushregs               #locate \x,\y               #printfmt \prefix,\strptr               jsr  popregs               .endm;--------------------------------------; Affiche un mot 16 bits en binaire ; issue d'une case memoire.;--------------------------------------printval16bin  .macro adresse               jsr  pushall               lda  #<\adresse               sta  $fb               lda  #>\adresse               sta  $fb+1               ldy  #$01                lda  ($fb),y               jsr  atobin               #printfmt "%", abin               dey               lda  ($fb),y               jsr  atobin               #print abin               jsr  popall               .endm;--------------------------------------; Affiche un mot 16 bits en binaire ; issue d'une case memoire (indirect).;--------------------------------------printptr16bin  .macro adresse               jsr  pushall               lda  #<\adresse               sta  $fb               lda  #>\adresse+1               sta  $fb+1               ldy  #$01                lda  $fb+1               jsr  atobin               #printfmt "%", abin               dey               lda  $fb               jsr  atobin               #print abin               jsr  popall               .endm;--------------------------------------