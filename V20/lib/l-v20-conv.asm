;---------------------------------------; nom fichier..: l-conv.asm (seq); type fichier.: code; auteur.......: daniel lafrance; version......: 1.0.1; revision.....: 20251117;---------------------------------------; routines d'affichage de chaine de;  caractereponse utilisant les routines du;  kernal du ãommodore 64.;---------------------------------------putyxhex        .block        jsr pushall        tya        pha        jsr lsr4bits        jsr nibtohex        sta hexstr+0        pla        jsr nibtohex        sta hexstr+1        txa        jsr atohex        ldx #<hexstr+0        ldy #>hexstr+0        jsr putsyx        jsr popall        rts        .bend;---------------------------------------putahex        .block        jsr pushregs        jsr atohex        ldx #<hexstr+2        ldy #>hexstr+2        jsr putsyx        jsr popregs        rts        .bend;---------------------------------------atohex        .block        php        pha        pha        jsr lsr4bits        jsr nibtohex        sta hexstr+2        pla        jsr nibtohex        sta hexstr+3        lda #$00        sta hexstr+4        pla        plp        rts        .bend;-----------------------------------------------------------------------------; Affiche le contenu de abin à la position du curseur.;-----------------------------------------------------------------------------putabin   .block          jsr     pushregs          jsr     atobin          ldx     #<binstr          ldy     #>binstr          jsr     putsyx          jsr     popregs          rts          .bend;-----------------------------------------------------------------------------; Converti le contenu de A en chaine  binaire dans binstr. ;-----------------------------------------------------------------------------atobin    .block          jsr  pushregs          ldx  #8          ldy  #0          clcnextbit   rol          pha          adc  #$00          and  #$01          jsr  nibtohex          sta  binstr,y          pla          iny          dex          bne  nextbit          lda  #0          sta  binstr,y          jsr  popregs          rts          .bend          ;---------------------------------------lsr4bits          .block          php          lsr a          lsr a          lsr a          lsr a          plp          rts          .bend;---------------------------------------nibtohexb        .block        php        and #$0f        sed        clc        adc #$90        adc #$40        cld        plp        rts        .bend;---------------------------------------nibtohex        .block        php        sty myy        and #$0f        tay        lda hextbl,y        ldy myy        plp        rtshextbl  .byte $30,$31,$32,$33,$34        .byte $35,$36,$37,$38,$39        .byte $41,$42,$43,$44,$45        .byte $46myy     .byte $00              .bend;---------------------------------------;$(yyxx)= adreponsese du premier octet.;Acc    = le nombre d'octets.bytestohex        .block        jsr pushall        sty zp1+1        stx zp1        #outcar 32        #outcar 5        #outcar 36        jsr putyxhex   ; prn adreponsese        #outcar $20        #outcar 159        ldy #$00        taxanother sty offset        lda (zp1),y        jsr putahex        pha        jsr petsciiaddr        plapetscii sta $0400        pha        lda #$0dpetcol  sta $d800                pla        #outcar $20        iny        dex        bne another        ;#outcar 36        ;jsr putyxhex        jsr popall        rts;---------------------------------------; Routine qui modifie le code precedent;---------------------------------------petsciiaddr        jsr pushregs;        #ldyxptr scrnlin         ;jsr putyxhex        lda #31        clc        adc offset        jsr addatoyx        sty petscii+2        stx petscii+1        stx petcol+1        tya        and #%11111011 ;#%00000100        ora #$d8        sta petcol+2        tay        ;#outcar $0d        ;jsr putyxhex        jsr popregs        rts        .bend;---------------------------------------; une fonction qui convertie une chaine; hexadecimale ascii en binaire 16 bits.; $(yyxx) pointeur de chaine; $YYXX valeur de retourstrhexval                .block        jsr pushall ; sauve registre        sty zp1+1   ; ptr dans zp1        stx zp1        jsr strlen  ;len de $(yyxx)->a        beq oute    ; si 0 erreur C=1        ldy #$00    ; offset a 0        sty reponse+1; reponse a zero        sty reponse ;    ...nextc   lda (zp1),y ;charge un caractere        beq out     ;On  a fini        cpy #$00    ;si c'est le premier        beq norol   ; pas de rol        pha         ;        lda #$04    ;rol de 4 pos        jsr rolword ;        pla         ;norol   ora #%00100000        sec        sbc #$30        cmp #$0a        bcc lt10        sec        sbc #$27        ;jsr putahex        cmp #$10        bcs outelt10    ora reponse        sta reponse        iny        cpy #$04        bne nextc;sortie normaleout     jsr popall        clc          ;Carry 0 = good        ldy reponse+1        ldx reponse        rts;sortie erreuroute    jsr popall        sec        rts        .bend;---------------------------------------showra    .block          jsr pushregs          ldy kcol            #outcar snoir          cmp  #31          bpl okprn          pha          lda #'.'          jsr chrout          pla          jmp  noprnokprn     jsr chroutnoprn     #outcar 32          #outcar sbleu          #outcar 36          jsr putahex          #outcar 32          #outcar srouge          #outcar 37          jsr putabin          #outcar 32          #outcar smauve          pha          tax          lda #$00          jsr fiaxtf1          pla          sty kcol          jsr popregs          rts          .bend;---------------------------------------putahexdec          .block          jsr pushregs          jsr  curget    ; Sauvegarde la position du curseur.          #locate 1,22   ; Place le curseur sur la derniere ligne.          #outcar 32     ; Affiche un espace.          jsr  showra    ; Affiche .a en ascii, hexa, bin et dec.          cmp  #99       ; Estce que le code ascii est > 99 dec.          bpl  nospc     ; Non, on saute.          #outcar 32     ; Oui, on affiche un espace sur le dernier car.nospc     jsr  curput    ; Replkace le curseur à sa position initiale.          jsr popregs          rts          .bend;--------------------------------------; rol reponse sur 16 bits; nombre de rol dans arolword        .block        jsr pushregs        tayagain   clc        rol reponse        rol reponse+1        dey        bne again        jsr popregs        rts        .bend;--------------------------------------