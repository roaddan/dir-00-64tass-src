;--------------------------------------; nom fichier..: l-string.asm (seq); type fichier.: code pour t.m.p.; auteur.......: daniel lafrance; version......: 0.0.2; revision.....: 20251119,20251121;--------------------------------------; description:; routines d'affichage de chaines de; caracteres se terminant par $00 sans; recours au rom du Basic 2.0.;--------------------------------------; Decommentez les 4 lignes suivantes; pour tester:;--------------------------------------;         .include "e-64map.asm";         .include "e-vars.asm";         .include "e-float.asm";         .include "l-push.asm";--------------------------------------; Affiche une chaine pointee par $FBFC;--------------------------------------puts      .block          jsr pushall          ldy #$00   ; y = offsetnextc     lda ($fb),y;lit un caractere          beq out    ;si 0 on sort          jsr chrout ;on l'affiche          jsr inczp1 ;pointe le prochain          jmp nextc  ; et l'afficheout       jsr popall          rts          .bend;--------------------------------------; Affiche une chaine pointee par $yyxx;--------------------------------------putsyx    .block          jsr pushall;sauve reg + zps          stx $fb    ;$yyxx dans          sty $fb+1  ; zp1          jsr puts          jsr popall ;recup reg + zps          rts        .bend;--------------------------------------; Affiche une chaîne de caractères se; terminani par 0 à une position; x,y du curseur. ; Entrée  : Adresse $YYXX de la chaine; de caractères se terminant par 0.; Les deux premiers octets de la chaine; forment les positions X et Y ; (colonne, ligne) de la position du; texte. ; Sortie  : Aucune.;--------------------------------------putsxy        .block        jsr pushall;sauve reg + zps        stx $fb    ;$yyxx dans        sty $fb+1  ; zp1        ldy #$00        lda ($fb),y        tax        jsr inczp1        lda ($fb),y        jsr inczp1        tay        jsr gotoxy        jsr puts        jsr popall ;recup reg + zps        rts        .bend;--------------------------------------; Affiche une chaine $fcfb, couleur->A;--------------------------------------putsc     .block          php       ;flag sur stack          pha       ;acc sur stack          pha       ;sauvegarde acc          lda kcol  ;recup coul. carac.          sta curcol; et la sauvegarde          pla       ;recup. acc          sta kcol  ;place coul. voulue          jsr puts  ;affiche la chaine          lda curcol;recup coul. carac.          sta kcol  ; et la replace          pla       ;recup acc          plp       ;recup flag          rts          .bend;--------------------------------------; Affiche une chaine $yyxx, couleur->a;--------------------------------------putscyx   .block          php       ;sauve registres          pha       ; ...          pha       ;sauve acc          lda kcol  ;recup couleur carac.          sta curcol; et sauvegarde          pla       ;recup acc          sta kcol  ;place couleur carac.          jsr putsyx;affiche la chaine          lda curcol          sta kcol          pla          plp          rts          .bend;--------------------------------------; Affiche une chaîne de caractères se; terminani par 0 à une position; x,y du curseur et dans une couleur; donnée . ; Entrée:; Adresse $YYXX de la chaine de; caractères se terminant par 0.; Les trois premier octets de la chaine; forment la couleur du texte et les ; positions X et Y (colonne, ligne) de; la position du texte. ; Sortie  : Aucune.;--------------------------------------putscxy   .block          php       ;sauve registres          pha       ; ...          pha       ;sauve acc          lda kcol  ;recup couleur carac.          sta curcol; et sauvegarde          pla       ;recup acc          sta kcol   ;place couleur carac.          jsr putsyx ;affiche la chaine          lda curcol          sta kcol          pla          plp          rts          .bend;--------------------------------------; Positionne le curseur a l'ecran.; x=colonne, y=ligne; limites x(0-39), Y(0-24);--------------------------------------gotoxy    .block          jsr pushregs          txa ; interchange x et y          pha ; ...          tya ; ...          tax ; ...          pla ; ...          tay ; ...txlow     cpy #0          bpl txhigh          ldx #0txhigh    cpx #25          bmi tylow          ldx #24tylow     cpy #0          bpl tyhigh          ldy #0tyhigh    cpy #40          bmi allok          ldy #39allok     clc          jsr plot          jsr popregs          rts          .bend;--------------------------------------putnch        .block        jsr pushregsagain   jsr chrout        dex        bne again        jsr popregs        rts        .bend;--------------------------------------; $(yyxx) pointeur sur la chaine; retourne A longueur de la chainestrlen        .block        jsr pushall        sty zp1+1        stx zp1        ldy #$00        sty lennext    lda (zp1),y        beq out        inc len        iny        jmp nextout     jsr popall        lda len        rts        .bend;--------------------------------------; Positionne C=1 ou Sauvegarde C=0 le; curseur et la couleur par défaut.; Entrée  : Carry = 0 pour sauvegarder,; carry = 1 pour récupérer.; Sortie  : Aucune.;--------------------------------------cursor    .block          jsr  pushregs          bcc  get    ;C=0 récupération.          jsr  plot  ;récupère position          sty  cx     ;curseur et sauve           stx  cy     ;dans vars locales.          lda  kcol   ;Sauve couleur            sta  bcol   ; BASIC du texte.          jmp  out    ;Fini on sort.get       ldx  cy     ;C=1, charge x              ldy  cx     ; ligne, y col.          jsr  plot  ;Position curseur.          lda  bcol   ;replace couleur            sta  kcol ; basic sauvegardé.out       jsr  popregs           rts          .bend;--------------------------------------; Sauvegarde de la position du curseur.; Entrée  : Aucune.; Sortie  : Aucune.; Voir cette fonction plus haut.;--------------------------------------curgetcursave   .block          php          sec          jsr  cursor                   plp          rts          .bend;--------------------------------------; Récupere de la position du curseur.; Entrée  : Aucune.; Sortie  : Aucune.; Voir cette fonction plus haut.;--------------------------------------curputcurrest   .block          php          clc          jsr  cursor           plp          rts          .bend;--------------------------------------isprnable .block          php          cmp  #160          bcs  yes          cmp  133          bcs  no                    cmp  #32          bcs  yesno        plp          clc          rtsyes       plp          sec          rts          .bend;--------------------------------------